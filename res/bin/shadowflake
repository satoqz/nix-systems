#!/usr/bin/env sh

set -e

add_if_not_exists() {
  if [[ ! -f "$2" ]] || [[ -z $(grep "$1" "$2") ]]; then
	  echo "$1" >> "$2"
	fi
}

git_exclude() {
  add_if_not_exists "$1" .git/info/exclude
}

[ -f flake.nix ] && echo "error: already a flake!" && exit 1

[ -d .git ] || git init

git_exclude flake.nix
git_exclude flake.lock
git_exclude .direnv
git_exclude .envrc

nix flake init -t $FLAKE_URL

add_if_not_exists 'use flake path:"$(pwd)"' .envrc

direnv allow

