name: Build systems

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: moghlai
    
    runs-on: ${{ matrix.os }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Install Nix
      uses: cachix/install-nix-action@v18

    - name: Setup Cachix
      uses: cachix/cachix-action@v12
      with:
        name: systems
        authToken: ${{ secrets.CACHIX_AUTH_TOKEN }}

    - name: Build target
      run: |
        set -o pipefail
        nix build .#lib.top.${{ matrix.target }} --fallback --show-trace -v --log-format raw > >(tee /tmp/nix-build-out.log) 2> >(tee /tmp/nix-build-err.log >&2)

    - name: Output build failure
      if: failure()
      run: |
        drv=$(grep "For full logs, run" /tmp/nix-build-err.log | grep -oE "/nix/store/.*.drv")
        nix log $drv
        echo $drv
        exit 1

